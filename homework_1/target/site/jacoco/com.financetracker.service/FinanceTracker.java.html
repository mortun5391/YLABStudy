<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FinanceTracker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">finance-tracker</a> &gt; <a href="index.source.html" class="el_package">com.financetracker.service</a> &gt; <span class="el_source">FinanceTracker.java</span></div><h1>FinanceTracker.java</h1><pre class="source lang-java linenums">package com.financetracker.service;

import com.financetracker.model.BudgetRecord;
import com.financetracker.model.Goal;
import com.financetracker.model.Transaction;
import com.financetracker.model.User;

import java.time.LocalDate;
import java.util.*;

/**
 * Класс FinanceTracker представляет собой систему управления финансами,
 * которая позволяет регистрировать пользователей, управлять их транзакциями,
 * бюджетами и финансовыми целями, а также отправлять уведомления.
 * &lt;p&gt;
 * Основные функции:
 * - Регистрация и аутентификация пользователей.
 * - Управление транзакциями, бюджетами и целями.
 * - Отправка уведомлений через сервис NotificationService.
 */
public class FinanceTracker {
    /**
     * Текущий аутентифицированный пользователь.
     * Если пользователь не аутентифицирован, значение равно null.
     */
    private User currentUser;

    /**
     * Сервис для отправки уведомлений пользователям.
     */
    private NotificationService notificationService;

    private UserService userService;
    private TransactionService transactionService;
    private BudgetService budgetService;
    private GoalService goalService;

<span class="fc" id="L38">    public enum LoginResult {</span>
<span class="fc" id="L39">        SUCCESS,</span>
<span class="fc" id="L40">        INVALID_CREDENTIALS,</span>
<span class="fc" id="L41">        USER_BANNED</span>
    }


    /**
     * Конструктор класса FinanceTracker.
     * Инициализирует необходимые структуры данных и создает администратора по умолчанию.
     *
     * @param notificationService сервис уведомлений, который будет использоваться для отправки уведомлений.
     * @throws IllegalArgumentException если notificationService равен null.
     */

    public FinanceTracker(UserService userService, TransactionService transactionService, BudgetService budgetService,
<span class="fc" id="L54">                          GoalService goalService ,NotificationService notificationService) {</span>
<span class="fc" id="L55">        this.userService = userService;</span>
<span class="fc" id="L56">        this.transactionService = transactionService;</span>
<span class="fc" id="L57">        this.budgetService = budgetService;</span>
<span class="fc" id="L58">        this.goalService = goalService;</span>
<span class="fc" id="L59">        this.notificationService = notificationService;</span>
<span class="fc" id="L60">        userService.registerUser(&quot;admin@example.com&quot;,&quot;admin123&quot;, &quot;Admin&quot;, &quot;admin&quot;);</span>
<span class="fc" id="L61">    }</span>

    /**
     * Регистрирует нового пользователя в системе.
     *
     * @param email электронная почта пользователя. Не может быть null или пустой строкой.
     * @param password пароль пользователя. Не может быть null или пустой строкой.
     * @param name имя пользователя. Не может быть null или пустой строкой.
     * @param role статус пользователя. Не может быть null или пустой строкой.
     * @return true, если регистрация прошла успешно; false, если пользователь с таким email уже существует.
     * @throws IllegalArgumentException если любой из параметров равен null или пустой строке.
     */
    public boolean registerUser(String email, String password, String name, String role) {
<span class="fc" id="L74">        return userService.registerUser(email, password, name, role);</span>
    }

    /**
     * Выполняет вход пользователя в систему.
     *
     * @param email электронная почта пользователя. Не может быть null или пустой строкой.
     * @param password пароль пользователя. Не может быть null или пустой строкой.
     * @return true, если вход выполнен успешно; false, если пользователь не найден или пароль неверен.
     * @throws IllegalArgumentException если email или password равен null или пустой строке.
     */
    public LoginResult loginUser(String email, String password) {
        try {
<span class="fc bfc" id="L87" title="All 2 branches covered.">            if (userService.loginUser(email, password)) {</span>
<span class="fc" id="L88">                currentUser = userService.getUserByEmail(email);</span>
<span class="fc" id="L89">                return LoginResult.SUCCESS;</span>
            }
<span class="fc" id="L91">            return LoginResult.INVALID_CREDENTIALS;</span>
<span class="fc" id="L92">        } catch (IllegalStateException e) {</span>
<span class="fc" id="L93">            return LoginResult.USER_BANNED;</span>
        }
    }

    /**
     * Выход текущего пользователя из системы.
     * Устанавливает значение currentUser в null.
     */
    public void logoutUser() {
<span class="fc" id="L102">        currentUser = null;</span>
<span class="fc" id="L103">    }</span>


    /**
     * Удаляет пользователя из системы по его идентификатору.
     * Если удаляемый пользователь является текущим, выполняется выход из системы.
     *
     * @param id уникальный идентификатор пользователя.
     * @throws IllegalArgumentException если пользователь с указанным id не найден.
     */
    public void deleteUser(String id) {
<span class="fc" id="L114">        userService.deleteUser(id);</span>
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">        if (currentUser != null &amp;&amp; currentUser.getId().equals(id)) {</span>
<span class="fc" id="L116">            logoutUser();</span>
        }
<span class="fc" id="L118">    }</span>

    public void banUser(String id) {
<span class="fc" id="L121">        userService.banUser(id);</span>
<span class="fc" id="L122">    }</span>

    public String getId() {
<span class="fc" id="L125">        return currentUser.getId();</span>
    }

    public boolean hasAccess(String id) {
<span class="fc" id="L129">        return userService.hasAccess(id);</span>
    }

    public boolean isPasswordEqual(String password) {
<span class="fc" id="L133">        return userService.isPasswordEqual(currentUser.getId(), password);</span>
    }

    public boolean isUserExist(String id) {
<span class="fc" id="L137">        return userService.isUserExist(id);</span>
    }

    /**
     * Добавляет транзакцию для текущего пользователя.
     * Если транзакция является доходом и у пользователя установлена финансовая цель,
     * сумма транзакции добавляется к цели.
     *
     * @param amount сумма транзакции.
     * @param category категория транзакции.
     * @param date дата транзакции.
     * @param description описание транзакции.
     * @param isIncome true, если транзакция является доходом; false, если расходом.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void addTransaction(double amount, String category, LocalDate date,
                               String description, boolean isIncome) {
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L155">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L157">        String id = getId();</span>

<span class="fc" id="L159">        transactionService.addTransaction(id, amount ,category, date, description, isIncome);</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">        if (budgetService.isBudgetSet(id)) {</span>
<span class="pc bpc" id="L161" title="2 of 4 branches missed.">            if (!isIncome &amp;&amp; date.toString().substring(0,7).equals(budgetService.getMonth(id))) {</span>
<span class="fc" id="L162">                budgetService.addMonthlyExpress(id, amount);</span>
            }
        }
<span class="pc bpc" id="L165" title="1 of 4 branches missed.">        if (goalService.isGoalSet(id) &amp;&amp; isIncome) {</span>
<span class="nc" id="L166">            goalService.addAmount(id, amount);</span>
        }

<span class="fc" id="L169">    }</span>

    /**
     * Удаляет транзакцию у текущего пользователя по её идентификатору.
     *
     * @param id уникальный идентификатор транзакции.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public boolean removeTransaction(String id) {
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L179">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L181">       return transactionService.removeTransaction(currentUser.getId(), id);</span>
    }

    public boolean isTransactionThere(String id) {
<span class="fc" id="L185">        return transactionService.isTransactionThere(currentUser.getId(), id);</span>
    }

    public void setTransactionAmount(String id, double amount) {
<span class="fc" id="L189">        transactionService.setTransactionAmount(currentUser.getId(), id, amount);</span>
<span class="fc" id="L190">    }</span>

    public void setTransactionCategory(String id, String category) {
<span class="fc" id="L193">        transactionService.setTransactionCategory(currentUser.getId(), id, category);</span>
<span class="fc" id="L194">    }</span>

    public void setTransactionDescription(String id, String description) {
<span class="fc" id="L197">        transactionService.setTransactionDescription(currentUser.getId(), id, description);</span>
<span class="fc" id="L198">    }</span>

    public String viewTransactionsNoFilter(String id) {
<span class="fc" id="L201">        return transactionService.viewTransactionNoFilter(currentUser.getId());</span>
    }

    public String viewTransactionsDateFilter(String id, LocalDate dateFilter) {
<span class="fc" id="L205">        return transactionService.viewTransactionsDateFilter(id, dateFilter);</span>
    }

    public String viewTransactionsCategoryFilter(String id, String categoryFilter) {
<span class="fc" id="L209">        return transactionService.viewTransactionsCategoryFilter(id, categoryFilter);</span>
    }

    public String viewTransactionsIsIncomeFilter(String id, boolean isIncomeFilter) {
<span class="fc" id="L213">        return transactionService.viewTransactionsIsIncomeFilter(id, isIncomeFilter);</span>
    }

    /**
     * Изменяет email текущего пользователя.
     *
     * @param email новый email. Не может быть null или пустой строкой.
     * @throws IllegalArgumentException если email равен null или пустой строке.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void changeEmail(String email) {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L225">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L227">        userService.changeEmail(currentUser.getId(),email);</span>
<span class="fc" id="L228">    }</span>

    /**
     * Изменяет пароль текущего пользователя.
     *
     * @param password новый пароль. Не может быть null или пустой строкой.
     * @throws IllegalArgumentException если пароль равен null или пустой строке.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void changePassword(String password) {
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L239">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L241">        userService.changePassword(currentUser.getId(), password);</span>
<span class="fc" id="L242">    }</span>

    /**
     * Изменяет имя текущего пользователя.
     *
     * @param name новое имя. Не может быть null или пустой строкой.
     * @throws IllegalArgumentException если имя равно null или пустой строке.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void changeName(String name) {
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L253">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L255">        userService.changeName(currentUser.getId(), name);</span>
<span class="fc" id="L256">    }</span>

    /**
     * Отображает профиль текущего пользователя.
     * Выводит статус, имя, email и скрытый пароль.
     *
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public String viewProfile() {
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L266">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L268">        return userService.viewProfile(currentUser.getId());</span>
    }

    /**
     * Отображает список всех пользователей в системе.
     * Форматированный вывод включает ID, Email, Имя и Статус пользователя.
     * Метод доступен только для аутентифицированных пользователей.
     */
    public void viewUsersList() {
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">        if (currentUser == null) return;</span>
<span class="fc" id="L278">        userService.viewUsersList(currentUser.getId());</span>
<span class="fc" id="L279">    }</span>


    /**
     * Возвращает месяц, связанный с бюджетом пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return месяц, связанный с бюджетом.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public String getMonth(String id) {
<span class="fc" id="L290">        return budgetService.getMonth(id);</span>
    }

    /**
     * Добавляет бюджет для пользователя на указанный месяц.
     * Если у пользователя есть транзакции за этот месяц, они учитываются в расходах.
     *
     * @param month месяц для которого устанавливается бюджет.
     * @param budget сумма бюджета.
     * @throws IllegalArgumentException если месяц или сумма бюджета некорректны.
     */
    public void addBudget(String month, double budget) {
<span class="fc" id="L302">        budgetService.addBudget(currentUser.getId(), month, budget);</span>
<span class="fc" id="L303">        budgetService.addMonthlyExpress(currentUser.getId(),</span>
<span class="fc" id="L304">                transactionService.calculateMonthlyExpress(currentUser.getId(), month));</span>
<span class="fc" id="L305">    }</span>

    /**
     * Проверяет, установлен ли бюджет для пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return true, если бюджет установлен; false, если нет.
     */
    public boolean isBudgetSet(String id) {
<span class="fc" id="L314">        return budgetService.isBudgetSet(id);</span>
    }

    /**
     * Возвращает месячный бюджет пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return сумма месячного бюджета.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public double getMonthlyBudget(String id) {
<span class="fc" id="L325">        return budgetService.getMonthlyBudget(id);</span>
    }

    /**
     * Возвращает сумму расходов пользователя за текущий месяц.
     *
     * @param id уникальный идентификатор пользователя.
     * @return сумма расходов.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public double getMonthlyExpress(String id) {
<span class="fc" id="L336">        return budgetService.getMonthlyExpress(id);</span>
    }

    /**
     * Добавляет сумму к расходам пользователя за текущий месяц.
     *
     * @param id уникальный идентификатор пользователя.
     * @param express сумма расходов.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public void addMonthlyExpress(String id, double express) {
<span class="fc" id="L347">        budgetService.addMonthlyExpress(id, express);</span>
<span class="fc" id="L348">    }</span>

    /**
     * Возвращает оставшуюся сумму бюджета пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return оставшаяся сумма бюджета.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public double getRemaining(String id) {
<span class="fc" id="L358">        return budgetService.getRemaining(id);</span>
    }

    public String viewBudget() {
<span class="fc" id="L362">        return budgetService.viewBudget(currentUser.getId());</span>
    }
    /**
     * Устанавливает финансовую цель для пользователя.
     *
     * @param name название цели.
     * @param target целевая сумма.
     * @throws IllegalArgumentException если название цели или целевая сумма некорректны.
     */
    public void setGoal(String name, double target) {
<span class="fc" id="L372">        goalService.setGoal(currentUser.getId(), name, target);</span>
<span class="fc" id="L373">    }</span>

    /**
     * Добавляет сумму к текущему прогрессу финансовой цели пользователя.
     *
     * @param amount сумма для добавления.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public void addAmount(double amount) {
<span class="fc" id="L382">        goalService.addAmount(currentUser.getId(), amount);</span>
<span class="fc" id="L383">    }</span>

    /**
     * Проверяет, установлена ли финансовая цель для пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return true, если цель установлена; false, если нет.
     */
    public boolean isGoalSet(String id) {
<span class="fc" id="L392">        return goalService.isGoalSet(id);</span>
    }

    /**
     * Возвращает прогресс достижения финансовой цели пользователя в процентах.
     *
     * @param id уникальный идентификатор пользователя.
     * @return прогресс в процентах.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public int getProgress(String id) {
<span class="fc" id="L403">        return goalService.getProgress(id);</span>
    }

    /**
     * Возвращает целевую сумму финансовой цели пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return целевая сумма.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public double getTargetAmount(String id) {
<span class="fc" id="L414">        return goalService.getTargetAmount(id);</span>
    }

    /**
     * Возвращает название финансовой цели пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return название цели.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public String getGoalName(String id) {
<span class="fc" id="L425">        return goalService.getGoalName(id);</span>
    }

    public String viewGoal() {
<span class="fc" id="L429">        return goalService.viewGoal(currentUser.getId());</span>
    }

    /**
     * Возвращает текущий баланс пользователя.
     * Баланс рассчитывается как сумма всех доходов за вычетом всех расходов.
     *
     * @return текущий баланс пользователя.
     */
    public double getBalance() {
<span class="fc" id="L439">        return transactionService.getBalance(currentUser.getId());</span>
    }

    /**
     * Возвращает сумму доходов пользователя за указанный период.
     *
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return сумма доходов за период.
     */
    public double getIncomeOfPeriod(LocalDate start, LocalDate end) {
<span class="fc" id="L450">        return transactionService.getIncomeOfPeriod(currentUser.getId(),start,end);</span>
    }

    /**
     * Возвращает сумму расходов пользователя за указанный период.
     *
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return сумма расходов за период.
     */
    public double getExpensesOfPeriod(LocalDate start, LocalDate end) {
<span class="fc" id="L461">        return transactionService.getExpensesOfPeriod(currentUser.getId(), start, end);</span>
    }

    /**
     * Возвращает расходы пользователя по категориям за указанный период.
     *
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return Map&lt;String, Double&gt;, где ключ — категория, а значение — сумма расходов по этой категории.
     */
    public Map&lt;String, Double&gt; getExpensesByCategory(LocalDate start, LocalDate end) {
<span class="fc" id="L472">        return transactionService.getExpensesByCategory(currentUser.getId(), start, end);</span>
    }


    /**
     * Генерирует финансовый отчёт для пользователя за указанный период.
     * Отчёт включает текущий баланс, доходы, расходы и расходы по категориям.
     *
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return строка, содержащая финансовый отчёт.
     */
    public String generateReport(LocalDate start, LocalDate end) {
<span class="fc" id="L485">        return transactionService.generateReport(currentUser.getId(), start, end);</span>
    }

    /**
     * Проверяет, превышен ли лимит расходов пользователя.
     * Если лимит превышен, отправляет уведомление через сервис NotificationService.
     *
     * @param id уникальный идентификатор пользователя.
     * @param recipient получатель уведомления (например, email).
     */
    public void checkExpenseLimit(String id, String recipient) {
<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (!budgetService.isBudgetSet(id)) {</span>
<span class="nc" id="L497">            return;</span>
        }
<span class="nc" id="L499">        double expenseLimit = budgetService.getMonthlyBudget(id);</span>
<span class="nc" id="L500">        double totalExpenses = budgetService.getMonthlyExpress(id);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (totalExpenses &gt; expenseLimit) {</span>
<span class="nc" id="L502">            String message = String.format(&quot;Превышен лимит расходов! Текущие расходы: %.2f, Лимит: %.2f&quot;,</span>
<span class="nc" id="L503">                    totalExpenses, expenseLimit);</span>
<span class="nc" id="L504">            notificationService.sendNotification(recipient, message);</span>
        }
<span class="nc" id="L506">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>