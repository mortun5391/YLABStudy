<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FinanceTracker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">finance-tracker</a> &gt; <a href="index.source.html" class="el_package">com.financetracker.service</a> &gt; <span class="el_source">FinanceTracker.java</span></div><h1>FinanceTracker.java</h1><pre class="source lang-java linenums">package com.financetracker.service;

import com.financetracker.model.BudgetRecord;
import com.financetracker.model.Goal;
import com.financetracker.model.Transaction;
import com.financetracker.model.User;

import java.time.LocalDate;
import java.util.*;

/**
 * Класс FinanceTracker представляет собой систему управления финансами,
 * которая позволяет регистрировать пользователей, управлять их транзакциями,
 * бюджетами и финансовыми целями, а также отправлять уведомления.
 * &lt;p&gt;
 * Основные функции:
 * - Регистрация и аутентификация пользователей.
 * - Управление транзакциями, бюджетами и целями.
 * - Отправка уведомлений через сервис NotificationService.
 */
public class FinanceTracker {
    /**
     * Карта для хранения пользователей по их уникальному идентификатору.
     * Ключ: идентификатор пользователя (String).
     * Значение: объект User.
     */
    private Map&lt;String, User&gt; users;

    /**
     * Карта для хранения пользователей по их электронной почте.
     * Ключ: электронная почта пользователя (String).
     * Значение: объект User.
     */
    private Map&lt;String, User&gt; emailToUserMap;

    /**
     * Карта для хранения бюджетов пользователей.
     * Ключ: идентификатор бюджета (String).
     * Значение: объект BudgetRecord.
     */
    private Map&lt;String, BudgetRecord&gt; budgets;

    /**
     * Карта для хранения финансовых целей пользователей.
     * Ключ: идентификатор цели (String).
     * Значение: объект Goal.
     */
    private Map&lt;String, Goal&gt; goals;

    /**
     * Текущий аутентифицированный пользователь.
     * Если пользователь не аутентифицирован, значение равно null.
     */
    private User currentUser;

    /**
     * Сервис для отправки уведомлений пользователям.
     */
    private NotificationService notificationService;


    /**
     * Конструктор класса FinanceTracker.
     * Инициализирует необходимые структуры данных и создает администратора по умолчанию.
     *
     * @param notificationService сервис уведомлений, который будет использоваться для отправки уведомлений.
     * @throws IllegalArgumentException если notificationService равен null.
     */

<span class="fc" id="L70">    public FinanceTracker(NotificationService notificationService) {</span>
<span class="fc" id="L71">        users = new HashMap&lt;&gt;();</span>
<span class="fc" id="L72">        emailToUserMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L73">        budgets = new HashMap&lt;&gt;();</span>
<span class="fc" id="L74">        goals = new HashMap&lt;&gt;();</span>
<span class="fc" id="L75">        User admin = new User(&quot;admin@example.ru&quot;,&quot;admin123&quot;, &quot;Admin&quot;, &quot;admin&quot;);</span>
<span class="fc" id="L76">        users.put(admin.getId(), admin);</span>
<span class="fc" id="L77">        emailToUserMap.put(admin.getEmail(), admin);</span>
<span class="fc" id="L78">        this.notificationService = notificationService;</span>
<span class="fc" id="L79">    }</span>

    /**
     * Регистрирует нового пользователя в системе.
     *
     * @param email электронная почта пользователя. Не может быть null или пустой строкой.
     * @param password пароль пользователя. Не может быть null или пустой строкой.
     * @param name имя пользователя. Не может быть null или пустой строкой.
     * @param status статус пользователя. Не может быть null или пустой строкой.
     * @return true, если регистрация прошла успешно; false, если пользователь с таким email уже существует.
     * @throws IllegalArgumentException если любой из параметров равен null или пустой строке.
     */
    public boolean registerUser(String email, String password, String name, String status) {
<span class="pc bpc" id="L92" title="3 of 6 branches missed.">        if (email == null || email.trim().isEmpty() ||</span>
<span class="pc bpc" id="L93" title="2 of 4 branches missed.">                password == null || password.trim().isEmpty() ||</span>
<span class="pc bpc" id="L94" title="2 of 4 branches missed.">                name == null || name.trim().isEmpty() ||</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">                status == null || status.trim().isEmpty()) {</span>
<span class="nc" id="L96">            throw new IllegalArgumentException(&quot;Email, password, name, and status cannot be null or empty&quot;);</span>
        }
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (emailToUserMap.containsKey(email)) {</span>
<span class="fc" id="L99">            return false;</span>
        }
<span class="fc" id="L101">        User user = new User(email, password, name, status);</span>
<span class="fc" id="L102">        users.put(user.getId(), user);</span>
<span class="fc" id="L103">        emailToUserMap.put(user.getEmail(), user);</span>
<span class="fc" id="L104">        return true;</span>
    }

    /**
     * Выполняет вход пользователя в систему.
     *
     * @param email электронная почта пользователя. Не может быть null или пустой строкой.
     * @param password пароль пользователя. Не может быть null или пустой строкой.
     * @return true, если вход выполнен успешно; false, если пользователь не найден или пароль неверен.
     * @throws IllegalArgumentException если email или password равен null или пустой строке.
     */
    public boolean loginUser(String email, String password) {
<span class="pc bpc" id="L116" title="4 of 8 branches missed.">        if (email == null || email.trim().isEmpty() || password == null || password.trim().isEmpty()) {</span>
<span class="nc" id="L117">            throw new IllegalArgumentException(&quot;Email and password cannot be null or empty&quot;);</span>
        }
<span class="fc" id="L119">        User user = emailToUserMap.get(email);</span>
<span class="pc bpc" id="L120" title="1 of 4 branches missed.">        if (user != null &amp;&amp; user.getPassword().equals(password)) {</span>
<span class="fc" id="L121">            currentUser = user;</span>
<span class="fc" id="L122">            return true;</span>
        }
<span class="fc" id="L124">        return false;</span>
    }

    /**
     * Выход текущего пользователя из системы.
     * Устанавливает значение currentUser в null.
     */
    public void logoutUser() {
<span class="fc" id="L132">        currentUser = null;</span>
<span class="fc" id="L133">    }</span>


    /**
     * Удаляет пользователя из системы по его идентификатору.
     * Если удаляемый пользователь является текущим, выполняется выход из системы.
     *
     * @param id уникальный идентификатор пользователя.
     * @throws IllegalArgumentException если пользователь с указанным id не найден.
     */
    public void deleteUser(String id) {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        if (!users.containsKey(id)) {</span>
<span class="nc" id="L145">            throw new IllegalArgumentException(&quot;User with id &quot; + id + &quot; not found&quot;);</span>
        }
<span class="pc bpc" id="L147" title="2 of 4 branches missed.">        if (currentUser != null &amp;&amp; currentUser.getId().equals(id)) {</span>
<span class="fc" id="L148">            logoutUser();</span>
        }
<span class="fc" id="L150">        emailToUserMap.remove(users.get(id).getEmail());</span>
<span class="fc" id="L151">        users.remove(id);</span>
<span class="fc" id="L152">    }</span>

    /**
     * Возвращает текущего аутентифицированного пользователя.
     *
     * @return объект User, представляющий текущего пользователя; null, если пользователь не аутентифицирован.
     */
    public User getCurrentUser() {
<span class="fc" id="L160">        return currentUser;</span>
    }

    /**
     * Возвращает пользователя по его идентификатору.
     *
     * @param id уникальный идентификатор пользователя.
     * @return объект User, если пользователь найден; null, если пользователь отсутствует.
     */
    public User getUser(String id) {
<span class="fc" id="L170">        return users.get(id);</span>
    }


    /**
     * Добавляет транзакцию для текущего пользователя.
     * Если транзакция является доходом и у пользователя установлена финансовая цель,
     * сумма транзакции добавляется к цели.
     *
     * @param amount сумма транзакции.
     * @param category категория транзакции.
     * @param date дата транзакции.
     * @param description описание транзакции.
     * @param isIncome true, если транзакция является доходом; false, если расходом.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void addTransaction(double amount, String category, LocalDate date,
                               String description, boolean isIncome) {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L189">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L191">        currentUser.addTransaction(new Transaction(amount, category, date, description, isIncome));</span>
<span class="fc" id="L192">        String id = getCurrentUser().getId();</span>
<span class="pc bpc" id="L193" title="3 of 4 branches missed.">        if (isGoalSet(id) &amp;&amp; isIncome) {</span>
<span class="nc" id="L194">            addAmount(id, amount);</span>
        }

<span class="fc bfc" id="L197" title="All 2 branches covered.">        if (isBudgetSet(id)) {</span>
<span class="pc bpc" id="L198" title="2 of 4 branches missed.">            if (!isIncome &amp;&amp; date.toString().substring(0,7).equals(getMonth(id))) {</span>
<span class="nc" id="L199">                addMonthlyExpress(id, amount);</span>
            }
        }
<span class="fc" id="L202">    }</span>

    /**
     * Удаляет транзакцию у текущего пользователя по её идентификатору.
     *
     * @param id уникальный идентификатор транзакции.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void removeTransaction(String id) {
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if (currentUser == null) {</span>
<span class="fc" id="L212">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L214">        currentUser.getTransactions().remove(id);</span>
<span class="fc" id="L215">    }</span>

    /**
     * Возвращает транзакцию текущего пользователя по её идентификатору.
     *
     * @param id уникальный идентификатор транзакции.
     * @return объект Transaction, если транзакция найдена; null, если транзакция отсутствует.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public Transaction getTransaction(String id) {
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (currentUser == null) {</span>
<span class="fc" id="L226">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L228">        return currentUser.getTransaction(id);</span>
    }

    /**
     * Возвращает все транзакции пользователя по его идентификатору.
     *
     * @param id уникальный идентификатор пользователя.
     * @return Map&lt;String, Transaction&gt;, содержащая транзакции пользователя; пустая Map, если пользователь не найден.
     */
    public Map&lt;String, Transaction&gt; getTransactions(String id) {
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (users.containsKey(id)) {</span>
<span class="fc" id="L239">            return users.get(id).getTransactions();</span>
        }
<span class="nc" id="L241">        return Collections.emptyMap();</span>
    }

    /**
     * Изменяет email текущего пользователя.
     *
     * @param email новый email. Не может быть null или пустой строкой.
     * @throws IllegalArgumentException если email равен null или пустой строке.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void changeEmail(String email) {
<span class="fc bfc" id="L252" title="All 2 branches covered.">        if (currentUser == null) {</span>
<span class="fc" id="L253">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L255">        currentUser.setEmail(email);</span>
<span class="fc" id="L256">    }</span>

    /**
     * Изменяет пароль текущего пользователя.
     *
     * @param password новый пароль. Не может быть null или пустой строкой.
     * @throws IllegalArgumentException если пароль равен null или пустой строке.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void changePassword(String password) {
<span class="fc bfc" id="L266" title="All 2 branches covered.">        if (currentUser == null) {</span>
<span class="fc" id="L267">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L269">        currentUser.setPassword(password);</span>
<span class="fc" id="L270">    }</span>

    /**
     * Изменяет имя текущего пользователя.
     *
     * @param name новое имя. Не может быть null или пустой строкой.
     * @throws IllegalArgumentException если имя равно null или пустой строке.
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void changeName(String name) {
<span class="fc bfc" id="L280" title="All 2 branches covered.">        if (currentUser == null) {</span>
<span class="fc" id="L281">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L283">        currentUser.setName(name);</span>
<span class="fc" id="L284">    }</span>

    /**
     * Отображает профиль текущего пользователя.
     * Выводит статус, имя, email и скрытый пароль.
     *
     * @throws IllegalStateException если текущий пользователь не аутентифицирован.
     */
    public void viewProfile() {
<span class="fc bfc" id="L293" title="All 2 branches covered.">        if (currentUser == null) {</span>
<span class="fc" id="L294">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="fc" id="L296">        System.out.println(</span>
<span class="fc" id="L297">                &quot;\nСтатус: &quot; + currentUser.getStatus() +</span>
<span class="fc" id="L298">                        &quot;\nИмя: &quot; + currentUser.getName() +</span>
<span class="fc" id="L299">                        &quot;\nEmail: &quot; + currentUser.getEmail() +</span>
                        &quot;\nПароль: ******** &quot;);
<span class="fc" id="L301">    }</span>

    /**
     * Отображает список всех пользователей в системе.
     * Форматированный вывод включает ID, Email, Имя и Статус пользователя.
     * Метод доступен только для аутентифицированных пользователей.
     */
    public void viewUsersList() {
<span class="fc bfc" id="L309" title="All 2 branches covered.">        if (currentUser == null) return;</span>
<span class="fc" id="L310">        System.out.println(&quot;Список пользователей: &quot;);</span>
<span class="fc" id="L311">        System.out.printf(&quot;%-10s %-20s %-15s %-10s%n&quot;, &quot;ID&quot;, &quot;Email&quot;, &quot;Имя&quot;, &quot;Статус&quot;);</span>

        // Данные пользователей
<span class="fc bfc" id="L314" title="All 2 branches covered.">        for (User user : users.values()) {</span>
<span class="fc" id="L315">            System.out.printf(</span>
                    &quot;%-10s %-20s %-15s %-10s%n&quot;,
<span class="fc" id="L317">                    user.getId(),</span>
<span class="fc" id="L318">                    user.getEmail(),</span>
<span class="fc" id="L319">                    user.getName(),</span>
<span class="fc" id="L320">                    user.getStatus()</span>
            );
<span class="fc" id="L322">        }</span>
<span class="fc" id="L323">    }</span>


    /**
     * Возвращает месяц, связанный с бюджетом пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return месяц, связанный с бюджетом.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public String getMonth(String id) {
<span class="fc bfc" id="L334" title="All 2 branches covered.">        if (!budgets.containsKey(id)) {</span>
<span class="fc" id="L335">            throw new IllegalArgumentException(&quot;Budget for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L337">        return budgets.get(id).getMonth();</span>
    }

    /**
     * Добавляет бюджет для пользователя на указанный месяц.
     * Если у пользователя есть транзакции за этот месяц, они учитываются в расходах.
     *
     * @param id уникальный идентификатор пользователя.
     * @param month месяц для которого устанавливается бюджет.
     * @param budget сумма бюджета.
     * @throws IllegalArgumentException если месяц или сумма бюджета некорректны.
     */
    public void addBudget(String id, String month, double budget) {
<span class="pc bpc" id="L350" title="3 of 6 branches missed.">        if (month == null || month.trim().isEmpty() || budget &lt; 0) {</span>
<span class="nc" id="L351">            throw new IllegalArgumentException(&quot;Month cannot be null or empty, and budget must be non-negative&quot;);</span>
        }
<span class="fc" id="L353">        budgets.put(id, new BudgetRecord(month, budget));</span>
<span class="fc" id="L354">        Map&lt;String, Transaction&gt; transactions = getTransactions(id);</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">        for (Transaction transaction : transactions.values()) {</span>
<span class="nc bnc" id="L356" title="All 4 branches missed.">            if (!transaction.isIncome() &amp;&amp; transaction.getDate().toString().substring(0, 7).equals(month)) {</span>
<span class="nc" id="L357">                addMonthlyExpress(id, transaction.getAmount());</span>
            }
<span class="nc" id="L359">        }</span>
<span class="fc" id="L360">    }</span>

    /**
     * Проверяет, установлен ли бюджет для пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return true, если бюджет установлен; false, если нет.
     */
    public boolean isBudgetSet(String id) {
<span class="fc" id="L369">        return budgets.containsKey(id);</span>
    }

    /**
     * Возвращает месячный бюджет пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return сумма месячного бюджета.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public double getMonthlyBudget(String id) {
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">        if (!budgets.containsKey(id)) {</span>
<span class="nc" id="L381">            throw new IllegalArgumentException(&quot;Budget for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L383">        return budgets.get(id).getBudget();</span>
    }

    /**
     * Возвращает сумму расходов пользователя за текущий месяц.
     *
     * @param id уникальный идентификатор пользователя.
     * @return сумма расходов.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public double getMonthlyExpress(String id) {
<span class="fc bfc" id="L394" title="All 2 branches covered.">        if (!budgets.containsKey(id)) {</span>
<span class="fc" id="L395">            throw new IllegalArgumentException(&quot;Budget for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L397">        return budgets.get(id).getExpress();</span>
    }

    /**
     * Добавляет сумму к расходам пользователя за текущий месяц.
     *
     * @param id уникальный идентификатор пользователя.
     * @param express сумма расходов.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public void addMonthlyExpress(String id, double express) {
<span class="fc bfc" id="L408" title="All 2 branches covered.">        if (!budgets.containsKey(id)) {</span>
<span class="fc" id="L409">            throw new IllegalArgumentException(&quot;Budget for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L411">        budgets.get(id).addExpress(express);</span>
<span class="fc" id="L412">    }</span>

    /**
     * Возвращает оставшуюся сумму бюджета пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return оставшаяся сумма бюджета.
     * @throws IllegalArgumentException если бюджет для пользователя не установлен.
     */
    public double getRemaining(String id) {
<span class="fc bfc" id="L422" title="All 2 branches covered.">        if (!budgets.containsKey(id)) {</span>
<span class="fc" id="L423">            throw new IllegalArgumentException(&quot;Budget for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L425">        return budgets.get(id).getBudget() - budgets.get(id).getExpress();</span>
    }

    /**
     * Устанавливает финансовую цель для пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @param name название цели.
     * @param target целевая сумма.
     * @throws IllegalArgumentException если название цели или целевая сумма некорректны.
     */
    public void setGoal(String id, String name, double target) {
<span class="pc bpc" id="L437" title="3 of 6 branches missed.">        if (name == null || name.trim().isEmpty() || target &lt; 0) {</span>
<span class="nc" id="L438">            throw new IllegalArgumentException(&quot;Goal name cannot be null or empty, and target must be non-negative&quot;);</span>
        }
<span class="fc" id="L440">        goals.put(id, new Goal(target, name));</span>
<span class="fc" id="L441">    }</span>

    /**
     * Добавляет сумму к текущему прогрессу финансовой цели пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @param amount сумма для добавления.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public void addAmount(String id, double amount) {
<span class="fc bfc" id="L451" title="All 2 branches covered.">        if (!goals.containsKey(id)) {</span>
<span class="fc" id="L452">            throw new IllegalArgumentException(&quot;Goal for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L454">        goals.get(id).addCurrentAmount(amount);</span>
<span class="fc" id="L455">    }</span>

    /**
     * Проверяет, установлена ли финансовая цель для пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return true, если цель установлена; false, если нет.
     */
    public boolean isGoalSet(String id) {
<span class="fc" id="L464">        return goals.containsKey(id);</span>
    }

    /**
     * Возвращает прогресс достижения финансовой цели пользователя в процентах.
     *
     * @param id уникальный идентификатор пользователя.
     * @return прогресс в процентах.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public int getProgress(String id) {
<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (!goals.containsKey(id)) {</span>
<span class="fc" id="L476">            throw new IllegalArgumentException(&quot;Goal for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L478">        return goals.get(id).getProgress();</span>
    }

    /**
     * Возвращает целевую сумму финансовой цели пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return целевая сумма.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public double getTargetAmount(String id) {
<span class="fc bfc" id="L489" title="All 2 branches covered.">        if (!goals.containsKey(id)) {</span>
<span class="fc" id="L490">            throw new IllegalArgumentException(&quot;Goal for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L492">        return goals.get(id).getTargetAmount();</span>
    }

    /**
     * Возвращает название финансовой цели пользователя.
     *
     * @param id уникальный идентификатор пользователя.
     * @return название цели.
     * @throws IllegalArgumentException если цель для пользователя не установлена.
     */
    public String getGoalName(String id) {
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (!goals.containsKey(id)) {</span>
<span class="nc" id="L504">            throw new IllegalArgumentException(&quot;Goal for user with id &quot; + id + &quot; is not set&quot;);</span>
        }
<span class="fc" id="L506">        return goals.get(id).getGoalName();</span>
    }

    /**
     * Возвращает текущий баланс пользователя.
     * Баланс рассчитывается как сумма всех доходов за вычетом всех расходов.
     *
     * @param id уникальный идентификатор пользователя.
     * @return текущий баланс пользователя.
     */
    public double getBalance(String id) {
<span class="fc" id="L517">        return getTransactions(id).values().stream()</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">                .mapToDouble(transaction -&gt; transaction.isIncome() ? transaction.getAmount() : -transaction.getAmount())</span>
<span class="fc" id="L519">                .sum();</span>
    }

    /**
     * Возвращает сумму доходов пользователя за указанный период.
     *
     * @param id уникальный идентификатор пользователя.
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return сумма доходов за период.
     */
    public double getIncomeOfPeriod(String id, LocalDate start, LocalDate end) {
<span class="fc" id="L531">        return getTransactions(id).values().stream()</span>
<span class="pc bpc" id="L532" title="1 of 4 branches missed.">                .mapToDouble(transaction -&gt; transaction.isIncome() &amp;&amp; transaction.getDate().isAfter(start.minusDays(1))</span>
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">                        &amp;&amp; transaction.getDate().isBefore(end.plusDays(1)) ? transaction.getAmount() : 0)</span>
<span class="fc" id="L534">                .sum();</span>
    }

    /**
     * Возвращает сумму расходов пользователя за указанный период.
     *
     * @param id уникальный идентификатор пользователя.
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return сумма расходов за период.
     */
    public double getExpensesOfPeriod(String id, LocalDate start, LocalDate end) {
<span class="fc" id="L546">        return getTransactions(id).values().stream()</span>
<span class="pc bpc" id="L547" title="1 of 4 branches missed.">                .mapToDouble(transaction -&gt; !transaction.isIncome() &amp;&amp; transaction.getDate().isAfter(start.minusDays(1))</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">                        &amp;&amp; transaction.getDate().isBefore(end.plusDays(1)) ? transaction.getAmount() : 0)</span>
<span class="fc" id="L549">                .sum();</span>
    }

    /**
     * Возвращает расходы пользователя по категориям за указанный период.
     *
     * @param id уникальный идентификатор пользователя.
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return Map&lt;String, Double&gt;, где ключ — категория, а значение — сумма расходов по этой категории.
     */
    public Map&lt;String, Double&gt; getExpensesByCategory(String id, LocalDate start, LocalDate end) {
<span class="fc" id="L561">        List&lt;Transaction&gt; transactions = getTransactions(id).values().stream().toList();</span>

<span class="fc" id="L563">        Map&lt;String, Double&gt; expensesByCategory = new HashMap&lt;&gt;();</span>

<span class="fc" id="L565">        transactions.stream()</span>
<span class="fc bfc" id="L566" title="All 2 branches covered.">                .filter(transaction -&gt; !transaction.isIncome())</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">                .filter(transaction -&gt; !transaction.getDate().isBefore(start) &amp;&amp;</span>
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">                        !transaction.getDate().isAfter(end)) // Только расходы</span>
<span class="fc" id="L569">                .forEach(transaction -&gt; {</span>
<span class="fc" id="L570">                    expensesByCategory.merge(transaction.getCategory(), transaction.getAmount(), Double::sum);</span>
<span class="fc" id="L571">                });</span>

<span class="fc" id="L573">        return expensesByCategory;</span>
    }

    /**
     * Генерирует финансовый отчёт для пользователя за указанный период.
     * Отчёт включает текущий баланс, доходы, расходы и расходы по категориям.
     *
     * @param id уникальный идентификатор пользователя.
     * @param start начальная дата периода.
     * @param end конечная дата периода.
     * @return строка, содержащая финансовый отчёт.
     */
    public String generateReport(String id, LocalDate start, LocalDate end) {
<span class="fc" id="L586">        double balance = getBalance(id);</span>
<span class="fc" id="L587">        double income = getIncomeOfPeriod(id, start, end);</span>
<span class="fc" id="L588">        double expense = getExpensesOfPeriod(id, start, end);</span>
<span class="fc" id="L589">        Map&lt;String, Double&gt; expensesByCategory = getExpensesByCategory(id, start, end);</span>

<span class="fc" id="L591">        StringBuilder report = new StringBuilder();</span>
<span class="fc" id="L592">        report.append(&quot;=== Финансовый отчёт ===\n&quot;);</span>
<span class="fc" id="L593">        report.append(String.format(&quot;Текущий баланс: %.2f \n&quot;, balance));</span>
<span class="fc" id="L594">        report.append(String.format(&quot;Доход за период: %.2f \n&quot;, income));</span>
<span class="fc" id="L595">        report.append(String.format(&quot;Расход за период: %.2f \n&quot;, expense));</span>
<span class="fc" id="L596">        report.append(&quot;Расходы по категориям:\n&quot;);</span>
<span class="fc" id="L597">        expensesByCategory.forEach((category, amount) -&gt;</span>
<span class="fc" id="L598">                report.append(String.format(&quot;- %s: %.2f \n&quot;, category, amount)));</span>
<span class="fc" id="L599">        return report.toString();</span>
    }

    /**
     * Проверяет, превышен ли лимит расходов пользователя.
     * Если лимит превышен, отправляет уведомление через сервис NotificationService.
     *
     * @param id уникальный идентификатор пользователя.
     * @param recipient получатель уведомления (например, email).
     */
    public void checkExpenseLimit(String id, String recipient) {
<span class="fc bfc" id="L610" title="All 2 branches covered.">        if (!budgets.containsKey(id)) {</span>
<span class="fc" id="L611">            return;</span>
        }
<span class="fc" id="L613">        double expenseLimit = budgets.get(id).getBudget();</span>

<span class="fc" id="L615">        double totalExpenses = budgets.get(id).getExpress();</span>
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">        if (totalExpenses &gt; expenseLimit) {</span>
<span class="nc" id="L617">            String message = String.format(&quot;Превышен лимит расходов! Текущие расходы: %.2f, Лимит: %.2f&quot;,</span>
<span class="nc" id="L618">                    totalExpenses, expenseLimit);</span>
<span class="nc" id="L619">            notificationService.sendNotification(recipient, message);</span>
        }
<span class="fc" id="L621">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>