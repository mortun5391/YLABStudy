<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FinanceTracker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">finance-tracker</a> &gt; <a href="index.source.html" class="el_package">com.financetracker.service</a> &gt; <span class="el_source">FinanceTracker.java</span></div><h1>FinanceTracker.java</h1><pre class="source lang-java linenums">package com.financetracker.service;

import com.financetracker.model.Transaction;
import com.financetracker.model.User;

import java.time.LocalDate;
import java.util.Map;

/**
 * Класс FinanceTracker представляет собой систему управления финансами,
 * которая позволяет регистрировать пользователей, управлять их транзакциями,
 * бюджетами и финансовыми целями, а также отправлять уведомления.
 */
public class FinanceTracker {
    private User currentUser;
    private NotificationService notificationService;
    private UserService userService;
    private TransactionService transactionService;
    private BudgetService budgetService;
    private GoalService goalService;

    /**
     * Результат попытки входа пользователя.
     */
<span class="nc" id="L25">    public enum LoginResult {</span>
<span class="nc" id="L26">        SUCCESS,</span>
<span class="nc" id="L27">        INVALID_CREDENTIALS,</span>
<span class="nc" id="L28">        USER_BANNED</span>
    }

    /**
     * Конструктор класса FinanceTracker.
     *
     * @param userService        сервис для работы с пользователями.
     * @param transactionService сервис для работы с транзакциями.
     * @param budgetService      сервис для работы с бюджетами.
     * @param goalService        сервис для работы с финансовыми целями.
     * @param notificationService сервис уведомлений.
     */
    public FinanceTracker(UserService userService, TransactionService transactionService,
                          BudgetService budgetService, GoalService goalService,
<span class="nc" id="L42">                          NotificationService notificationService) {</span>
<span class="nc" id="L43">        this.userService = userService;</span>
<span class="nc" id="L44">        this.transactionService = transactionService;</span>
<span class="nc" id="L45">        this.budgetService = budgetService;</span>
<span class="nc" id="L46">        this.goalService = goalService;</span>
<span class="nc" id="L47">        this.notificationService = notificationService;</span>

        // Регистрация администратора по умолчанию
<span class="nc" id="L50">        userService.registerUser(&quot;admin@example.com&quot;, &quot;admin123&quot;, &quot;Admin&quot;, &quot;admin&quot;);</span>
<span class="nc" id="L51">    }</span>

    /**
     * Регистрирует нового пользователя в системе.
     *
     * @param email    электронная почта пользователя.
     * @param password пароль пользователя.
     * @param name     имя пользователя.
     * @param role     роль пользователя.
     * @return true, если регистрация прошла успешно; false, если пользователь с таким email уже существует.
     */
    public boolean registerUser(String email, String password, String name, String role) {
<span class="nc" id="L63">        return userService.registerUser(email, password, name, role);</span>
    }

    /**
     * Выполняет вход пользователя в систему.
     *
     * @param email    электронная почта пользователя.
     * @param password пароль пользователя.
     * @return результат попытки входа (SUCCESS, INVALID_CREDENTIALS, USER_BANNED).
     */
    public LoginResult loginUser(String email, String password) {
        try {
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (userService.loginUser(email, password)) {</span>
<span class="nc" id="L76">                currentUser = userService.getUserByEmail(email).orElse(null);</span>
<span class="nc" id="L77">                return LoginResult.SUCCESS;</span>
            }
<span class="nc" id="L79">            return LoginResult.INVALID_CREDENTIALS;</span>
<span class="nc" id="L80">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L81">            return LoginResult.USER_BANNED;</span>
        }
    }

    /**
     * Выход текущего пользователя из системы.
     */
    public void logoutUser() {
<span class="nc" id="L89">        currentUser = null;</span>
<span class="nc" id="L90">    }</span>

    /**
     * Удаляет пользователя из системы по его идентификатору.
     *
     * @param id уникальный идентификатор пользователя.
     */
    public void deleteUser(long id) {
<span class="nc" id="L98">        userService.deleteUser(id);</span>
<span class="nc bnc" id="L99" title="All 4 branches missed.">        if (currentUser != null &amp;&amp; currentUser.getId() == id) {</span>
<span class="nc" id="L100">            logoutUser();</span>
        }
<span class="nc" id="L102">    }</span>

    /**
     * Блокирует пользователя по его идентификатору.
     *
     * @param id уникальный идентификатор пользователя.
     */
    public void banUser(long id) {
<span class="nc" id="L110">        userService.banUser(id);</span>
<span class="nc" id="L111">    }</span>

    /**
     * Возвращает идентификатор текущего пользователя.
     *
     * @return идентификатор текущего пользователя.
     */
    public long getId() {
<span class="nc" id="L119">        return currentUser.getId();</span>
    }

    /**
     * Проверяет, имеет ли пользователь доступ к определенным операциям.
     *
     * @param id уникальный идентификатор пользователя.
     * @return true, если пользователь имеет доступ; false, если нет.
     */
    public boolean hasAccess(long id) {
<span class="nc" id="L129">        return userService.hasAccess(id);</span>
    }

    /**
     * Проверяет, совпадает ли пароль пользователя с указанным паролем.
     *
     * @param password пароль для проверки.
     * @return true, если пароль совпадает; false, если нет.
     */
    public boolean isPasswordEqual(String password) {
<span class="nc" id="L139">        return userService.isPasswordEqual(currentUser.getId(), password);</span>
    }

    /**
     * Проверяет, существует ли пользователь с указанным идентификатором.
     *
     * @param id уникальный идентификатор пользователя.
     * @return true, если пользователь существует; false, если нет.
     */
    public boolean isUserExist(long id) {
<span class="nc" id="L149">        return userService.isUserExist(id);</span>
    }

    /**
     * Добавляет транзакцию для текущего пользователя.
     *
     * @param amount      сумма транзакции.
     * @param category    категория транзакции.
     * @param date        дата транзакции.
     * @param description описание транзакции.
     * @param isIncome    true, если транзакция является доходом; false, если расходом.
     */
    public void addTransaction(double amount, String category, LocalDate date,
                               String description, boolean isIncome) {
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L164">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="nc" id="L166">        long id = currentUser.getId();</span>

<span class="nc" id="L168">        transactionService.addTransaction(new Transaction(id, amount, category, date, description, isIncome));</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (budgetService.isBudgetSet(id)) {</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">            if (!isIncome &amp;&amp; date.toString().substring(0, 7).equals(budgetService.getMonth(id))) {</span>
<span class="nc" id="L171">                budgetService.addMonthlyExpress(id, amount);</span>
            }
        }
<span class="nc bnc" id="L174" title="All 4 branches missed.">        if (goalService.isGoalSet(id) &amp;&amp; isIncome) {</span>
<span class="nc" id="L175">            goalService.addAmount(id, amount);</span>
        }
<span class="nc" id="L177">    }</span>

    /**
     * Удаляет транзакцию у текущего пользователя по её идентификатору.
     *
     * @param transactionId уникальный идентификатор транзакции.
     * @return true, если транзакция успешно удалена; false, если транзакция не найдена.
     */
    public boolean removeTransaction(long transactionId) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L187">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="nc" id="L189">        return transactionService.removeTransaction(transactionId);</span>
    }

    /**
     * Проверяет, существует ли транзакция с указанным идентификатором у текущего пользователя.
     *
     * @param transactionId уникальный идентификатор транзакции.
     * @return true, если транзакция существует; false, если нет.
     */
    public boolean isTransactionThere(long transactionId) {
<span class="nc" id="L199">        return transactionService.isTransactionThere(transactionId);</span>
    }

    /**
     * Устанавливает новую сумму для транзакции.
     *
     * @param transactionId уникальный идентификатор транзакции.
     * @param amount        новая сумма транзакции.
     */
    public void setTransactionAmount(long transactionId, double amount) {
<span class="nc" id="L209">        transactionService.setTransactionAmount(transactionId, amount);</span>
<span class="nc" id="L210">    }</span>

    /**
     * Устанавливает новую категорию для транзакции.
     *
     * @param transactionId уникальный идентификатор транзакции.
     * @param category      новая категория транзакции.
     */
    public void setTransactionCategory(long transactionId, String category) {
<span class="nc" id="L219">        transactionService.setTransactionCategory(transactionId, category);</span>
<span class="nc" id="L220">    }</span>

    /**
     * Устанавливает новое описание для транзакции.
     *
     * @param transactionId уникальный идентификатор транзакции.
     * @param description   новое описание транзакции.
     */
    public void setTransactionDescription(long transactionId, String description) {
<span class="nc" id="L229">        transactionService.setTransactionDescription(transactionId, description);</span>
<span class="nc" id="L230">    }</span>

    /**
     * Возвращает список всех транзакций текущего пользователя без фильтрации.
     *
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsNoFilter(long id) {
<span class="nc" id="L238">        return transactionService.viewTransactionNoFilter(id);</span>
    }

    /**
     * Возвращает список транзакций текущего пользователя, отфильтрованных по дате.
     *
     * @param dateFilter дата для фильтрации.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsDateFilter(long id,LocalDate dateFilter) {
<span class="nc" id="L248">        return transactionService.viewTransactionsDateFilter(id, dateFilter);</span>
    }

    /**
     * Возвращает список транзакций текущего пользователя, отфильтрованных по категории.
     *
     * @param categoryFilter категория для фильтрации.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsCategoryFilter(long id, String categoryFilter) {
<span class="nc" id="L258">        return transactionService.viewTransactionsCategoryFilter(id, categoryFilter);</span>
    }

    /**
     * Возвращает список транзакций текущего пользователя, отфильтрованных по типу (доход/расход).
     *
     * @param isIncomeFilter true для доходов, false для расходов.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsIsIncomeFilter(long id, boolean isIncomeFilter) {
<span class="nc" id="L268">        return transactionService.viewTransactionsIsIncomeFilter(id, isIncomeFilter);</span>
    }

    /**
     * Изменяет email текущего пользователя.
     *
     * @param email новый email.
     */
    public void changeEmail(String email) {
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L278">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="nc" id="L280">        userService.changeEmail(currentUser.getId(), email);</span>
<span class="nc" id="L281">    }</span>

    /**
     * Изменяет пароль текущего пользователя.
     *
     * @param password новый пароль.
     */
    public void changePassword(String password) {
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L290">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="nc" id="L292">        userService.changePassword(currentUser.getId(), password);</span>
<span class="nc" id="L293">    }</span>

    /**
     * Изменяет имя текущего пользователя.
     *
     * @param name новое имя.
     */
    public void changeName(String name) {
<span class="nc bnc" id="L301" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L302">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="nc" id="L304">        userService.changeName(currentUser.getId(), name);</span>
<span class="nc" id="L305">    }</span>

    /**
     * Отображает профиль текущего пользователя.
     *
     * @return строка, содержащая информацию о профиле.
     */
    public String viewProfile() {
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (currentUser == null) {</span>
<span class="nc" id="L314">            throw new IllegalStateException(&quot;No user is currently logged in&quot;);</span>
        }
<span class="nc" id="L316">        return userService.viewProfile(currentUser.getId());</span>
    }

    /**
     * Отображает список всех пользователей в системе.
     */
    public void viewUsersList() {
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (currentUser == null) return;</span>
<span class="nc" id="L324">        userService.viewUsersList(currentUser.getId());</span>
<span class="nc" id="L325">    }</span>

    /**
     * Возвращает месяц, связанный с бюджетом пользователя.
     *
     * @return месяц, связанный с бюджетом.
     */
    public String getMonth() {
<span class="nc" id="L333">        return budgetService.getMonth(currentUser.getId());</span>
    }

    /**
     * Добавляет бюджет для пользователя на указанный месяц.
     *
     * @param month  месяц для которого устанавливается бюджет.
     * @param budget сумма бюджета.
     */
    public void addBudget(String month, double budget) {
<span class="nc" id="L343">        budgetService.addBudget(currentUser.getId(), month, budget);</span>
<span class="nc" id="L344">        budgetService.addMonthlyExpress(currentUser.getId(),</span>
<span class="nc" id="L345">                transactionService.calculateMonthlyExpress(currentUser.getId(), month));</span>
<span class="nc" id="L346">    }</span>

    /**
     * Проверяет, установлен ли бюджет для пользователя.
     *
     * @return true, если бюджет установлен; false, если нет.
     */
    public boolean isBudgetSet() {
<span class="nc" id="L354">        return budgetService.isBudgetSet(currentUser.getId());</span>
    }

    /**
     * Возвращает месячный бюджет пользователя.
     *
     * @return сумма месячного бюджета.
     */
    public double getMonthlyBudget() {
<span class="nc" id="L363">        return budgetService.getMonthlyBudget(currentUser.getId());</span>
    }

    /**
     * Возвращает сумму расходов пользователя за текущий месяц.
     *
     * @return сумма расходов.
     */
    public double getMonthlyExpress() {
<span class="nc" id="L372">        return budgetService.getMonthlyExpress(currentUser.getId());</span>
    }

    /**
     * Возвращает оставшуюся сумму бюджета пользователя.
     *
     * @return оставшаяся сумма бюджета.
     */
    public double getRemaining() {
<span class="nc" id="L381">        return budgetService.getRemaining(currentUser.getId());</span>
    }

    /**
     * Возвращает информацию о бюджете текущего пользователя.
     *
     * @return строка, содержащая информацию о бюджете.
     */
    public String viewBudget() {
<span class="nc" id="L390">        return budgetService.viewBudget(currentUser.getId());</span>
    }

    /**
     * Устанавливает финансовую цель для пользователя.
     *
     * @param name   название цели.
     * @param target целевая сумма.
     */
    public void setGoal(String name, double target) {
<span class="nc" id="L400">        goalService.setGoal(currentUser.getId(), name, target);</span>
<span class="nc" id="L401">    }</span>

    /**
     * Проверяет, установлена ли финансовая цель для пользователя.
     *
     * @return true, если цель установлена; false, если нет.
     */
    public boolean isGoalSet() {
<span class="nc" id="L409">        return goalService.isGoalSet(currentUser.getId());</span>
    }

    /**
     * Возвращает прогресс достижения финансовой цели пользователя в процентах.
     *
     * @return прогресс в процентах.
     */
    public int getProgress() {
<span class="nc" id="L418">        return goalService.getProgress(currentUser.getId());</span>
    }

    /**
     * Возвращает целевую сумму финансовой цели пользователя.
     *
     * @return целевая сумма.
     */
    public double getTargetAmount() {
<span class="nc" id="L427">        return goalService.getTargetAmount(currentUser.getId());</span>
    }

    /**
     * Возвращает название финансовой цели пользователя.
     *
     * @return название цели.
     */
    public String getGoalName() {
<span class="nc" id="L436">        return goalService.getGoalName(currentUser.getId());</span>
    }

    /**
     * Возвращает информацию о финансовой цели текущего пользователя.
     *
     * @return строка, содержащая информацию о цели.
     */
    public String viewGoal() {
<span class="nc" id="L445">        return goalService.viewGoal(currentUser.getId());</span>
    }

    /**
     * Возвращает текущий баланс пользователя.
     *
     * @return текущий баланс пользователя.
     */
    public double getBalance() {
<span class="nc" id="L454">        return transactionService.getBalance(currentUser.getId());</span>
    }

    /**
     * Возвращает сумму доходов пользователя за указанный период.
     *
     * @param start начальная дата периода.
     * @param end   конечная дата периода.
     * @return сумма доходов за период.
     */
    public double getIncomeOfPeriod(LocalDate start, LocalDate end) {
<span class="nc" id="L465">        return transactionService.getIncomeOfPeriod(currentUser.getId(), start, end);</span>
    }

    /**
     * Возвращает сумму расходов пользователя за указанный период.
     *
     * @param start начальная дата периода.
     * @param end   конечная дата периода.
     * @return сумма расходов за период.
     */
    public double getExpensesOfPeriod(LocalDate start, LocalDate end) {
<span class="nc" id="L476">        return transactionService.getExpensesOfPeriod(currentUser.getId(), start, end);</span>
    }

    /**
     * Возвращает строку с расходами по категориям за указанный период.
     *
     * @param start начальная дата периода.
     * @param end   конечная дата периода.
     * @return строка, содержащая расходы по категориям.
     */
    public String getExpensesByCategoryAsString(LocalDate start, LocalDate end) {
<span class="nc" id="L487">        Map&lt;String, Double&gt; expensesByCategory = transactionService.getExpensesByCategory(currentUser.getId(), start, end);</span>

<span class="nc" id="L489">        StringBuilder result = new StringBuilder(&quot;Расходы по категориям за период:\n&quot;);</span>
<span class="nc" id="L490">        expensesByCategory.forEach((category, amount) -&gt;</span>
<span class="nc" id="L491">                result.append(String.format(&quot;- %s: %.2f\n&quot;, category, amount)));</span>

<span class="nc" id="L493">        return result.toString();</span>
    }

    /**
     * Генерирует финансовый отчёт для пользователя за указанный период.
     *
     * @param start начальная дата периода.
     * @param end   конечная дата периода.
     * @return строка, содержащая финансовый отчёт.
     */
    public String generateReport(LocalDate start, LocalDate end) {
<span class="nc" id="L504">        return transactionService.generateReport(currentUser.getId(), start, end);</span>
    }

    /**
     * Проверяет, превышен ли лимит расходов пользователя.
     *
     * @param recipient получатель уведомления.
     */
    public void checkExpenseLimit(String recipient) {
<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (!budgetService.isBudgetSet(currentUser.getId())) {</span>
<span class="nc" id="L514">            return;</span>
        }
<span class="nc" id="L516">        double expenseLimit = budgetService.getMonthlyBudget(currentUser.getId());</span>
<span class="nc" id="L517">        double totalExpenses = budgetService.getMonthlyExpress(currentUser.getId());</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (totalExpenses &gt; expenseLimit) {</span>
<span class="nc" id="L519">            String message = String.format(&quot;Превышен лимит расходов! Текущие расходы: %.2f, Лимит: %.2f&quot;,</span>
<span class="nc" id="L520">                    totalExpenses, expenseLimit);</span>
<span class="nc" id="L521">            notificationService.sendNotification(recipient, message);</span>
        }
<span class="nc" id="L523">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>