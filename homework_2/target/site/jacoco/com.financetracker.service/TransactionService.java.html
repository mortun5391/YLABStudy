<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">finance-tracker</a> &gt; <a href="index.source.html" class="el_package">com.financetracker.service</a> &gt; <span class="el_source">TransactionService.java</span></div><h1>TransactionService.java</h1><pre class="source lang-java linenums">package com.financetracker.service;

import com.financetracker.model.Transaction;
import com.financetracker.repository.TransactionRepository;

import java.time.LocalDate;
import java.util.*;

/**
 * Сервис для управления транзакциями пользователей.
 */
public class TransactionService {

    private final TransactionRepository transactionRepository;

<span class="nc" id="L16">    public TransactionService(TransactionRepository transactionRepository) {</span>
<span class="nc" id="L17">        this.transactionRepository = transactionRepository;</span>
<span class="nc" id="L18">    }</span>

    /**
     * Добавляет транзакцию для указанного пользователя.
     *
     * @param transaction объект Transaction, который нужно сохранить.
     */
    public void addTransaction(Transaction transaction) {
<span class="nc" id="L26">        transactionRepository.addTransaction(transaction);</span>
<span class="nc" id="L27">    }</span>

    /**
     * Возвращает все транзакции пользователя.
     *
     * @param userId ID пользователя.
     * @return Список транзакций.
     */
    public List&lt;Transaction&gt; getTransactions(long userId) {
<span class="nc" id="L36">        return transactionRepository.findTransactionsByUserId(userId);</span>
    }

    /**
     * Возвращает транзакцию по её идентификатору.
     *
     * @param transactionId ID транзакции.
     * @return Объект транзакции или null, если транзакция не найдена.
     */
    public Optional&lt;Transaction&gt; getTransaction(long transactionId) {
<span class="nc" id="L46">        return transactionRepository.findTransactionById(transactionId);</span>
    }

    /**
     * Удаляет транзакцию по её идентификатору.
     *
     * @param transactionId ID транзакции.
     * @return true, если транзакция успешно удалена; false, если транзакция не найдена.
     */
    public boolean removeTransaction(long transactionId) {
<span class="nc" id="L56">        return transactionRepository.deleteTransaction(transactionId);</span>
    }

    /**
     * Проверяет, существует ли транзакция с указанным идентификатором.
     *
     * @param transactionId ID транзакции.
     * @return true, если транзакция существует; false, если нет.
     */
    public boolean isTransactionThere(long transactionId) {
<span class="nc" id="L66">        return transactionRepository.findTransactionById(transactionId).isPresent();</span>
    }

    /**
     * Устанавливает новую сумму для транзакции.
     *
     * @param transactionId ID транзакции.
     * @param amount        Новая сумма транзакции.
     */
    public void setTransactionAmount(long transactionId, double amount) {
<span class="nc" id="L76">        transactionRepository.findTransactionById(transactionId).ifPresent(transaction -&gt; {</span>
<span class="nc" id="L77">            transaction.setAmount(amount);</span>
<span class="nc" id="L78">            transactionRepository.updateTransaction(transaction);</span>
<span class="nc" id="L79">        });</span>
<span class="nc" id="L80">    }</span>

    /**
     * Устанавливает новую категорию для транзакции.
     *
     * @param transactionId ID транзакции.
     * @param category      Новая категория транзакции.
     */
    public void setTransactionCategory(long transactionId, String category) {
<span class="nc" id="L89">        transactionRepository.findTransactionById(transactionId).ifPresent(transaction -&gt; {</span>
<span class="nc" id="L90">            transaction.setCategory(category);</span>
<span class="nc" id="L91">            transactionRepository.updateTransaction(transaction);</span>
<span class="nc" id="L92">        });</span>
<span class="nc" id="L93">    }</span>

    /**
     * Устанавливает новое описание для транзакции.
     *
     * @param transactionId ID транзакции.
     * @param description   Новое описание транзакции.
     */
    public void setTransactionDescription(long transactionId, String description) {
<span class="nc" id="L102">        transactionRepository.findTransactionById(transactionId).ifPresent(transaction -&gt; {</span>
<span class="nc" id="L103">            transaction.setDescription(description);</span>
<span class="nc" id="L104">            transactionRepository.updateTransaction(transaction);</span>
<span class="nc" id="L105">        });</span>
<span class="nc" id="L106">    }</span>

    /**
     * Возвращает текущий баланс пользователя.
     *
     * @param userId ID пользователя.
     * @return Текущий баланс.
     */
    public double getBalance(long userId) {
<span class="nc" id="L115">        return transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                .mapToDouble(transaction -&gt; transaction.isIncome() ? transaction.getAmount() : -transaction.getAmount())</span>
<span class="nc" id="L117">                .sum();</span>
    }

    /**
     * Возвращает сумму доходов пользователя за указанный период.
     *
     * @param userId ID пользователя.
     * @param start  Начальная дата периода.
     * @param end    Конечная дата периода.
     * @return Сумма доходов за период.
     */
    public double getIncomeOfPeriod(long userId, LocalDate start, LocalDate end) {
<span class="nc" id="L129">        return transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                .filter(transaction -&gt; transaction.isIncome() &amp;&amp;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                        !transaction.getDate().isBefore(start) &amp;&amp;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                        !transaction.getDate().isAfter(end))</span>
<span class="nc" id="L133">                .mapToDouble(Transaction::getAmount)</span>
<span class="nc" id="L134">                .sum();</span>
    }

    /**
     * Возвращает сумму расходов пользователя за указанный период.
     *
     * @param userId ID пользователя.
     * @param start  Начальная дата периода.
     * @param end    Конечная дата периода.
     * @return Сумма расходов за период.
     */
    public double getExpensesOfPeriod(long userId, LocalDate start, LocalDate end) {
<span class="nc" id="L146">        return transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                .filter(transaction -&gt; !transaction.isIncome() &amp;&amp;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                        !transaction.getDate().isBefore(start) &amp;&amp;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                        !transaction.getDate().isAfter(end))</span>
<span class="nc" id="L150">                .mapToDouble(Transaction::getAmount)</span>
<span class="nc" id="L151">                .sum();</span>
    }

    /**
     * Возвращает расходы пользователя по категориям за указанный период.
     *
     * @param userId ID пользователя.
     * @param start  Начальная дата периода.
     * @param end    Конечная дата периода.
     * @return Map&lt;String, Double&gt;, где ключ — категория, а значение — сумма расходов.
     */
    public Map&lt;String, Double&gt; getExpensesByCategory(long userId, LocalDate start, LocalDate end) {
<span class="nc" id="L163">        Map&lt;String, Double&gt; expensesByCategory = new HashMap&lt;&gt;();</span>
<span class="nc" id="L164">        transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                .filter(transaction -&gt; !transaction.isIncome() &amp;&amp;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                        !transaction.getDate().isBefore(start) &amp;&amp;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                        !transaction.getDate().isAfter(end))</span>
<span class="nc" id="L168">                .forEach(transaction -&gt; {</span>
<span class="nc" id="L169">                    expensesByCategory.merge(transaction.getCategory(), transaction.getAmount(), Double::sum);</span>
<span class="nc" id="L170">                });</span>
<span class="nc" id="L171">        return expensesByCategory;</span>
    }

    /**
     * Рассчитывает сумму расходов пользователя за указанный месяц.
     *
     * @param userId ID пользователя.
     * @param month  Месяц в формате &quot;yyyy-MM&quot;.
     * @return Сумма расходов за месяц.
     */
    public double calculateMonthlyExpress(long userId, String month) {
<span class="nc" id="L182">        return transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                .filter(transaction -&gt; !transaction.isIncome() &amp;&amp;</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                        transaction.getDate().toString().substring(0, 7).equals(month))</span>
<span class="nc" id="L185">                .mapToDouble(Transaction::getAmount)</span>
<span class="nc" id="L186">                .sum();</span>
    }

    /**
     * Генерирует финансовый отчёт для пользователя за указанный период.
     *
     * @param userId ID пользователя.
     * @param start  Начальная дата периода.
     * @param end    Конечная дата периода.
     * @return Строка, содержащая финансовый отчёт.
     */
    public String generateReport(long userId, LocalDate start, LocalDate end) {
<span class="nc" id="L198">        double balance = getBalance(userId);</span>
<span class="nc" id="L199">        double income = getIncomeOfPeriod(userId, start, end);</span>
<span class="nc" id="L200">        double expense = getExpensesOfPeriod(userId, start, end);</span>
<span class="nc" id="L201">        Map&lt;String, Double&gt; expensesByCategory = getExpensesByCategory(userId, start, end);</span>

<span class="nc" id="L203">        StringBuilder report = new StringBuilder();</span>
<span class="nc" id="L204">        report.append(&quot;=== Финансовый отчёт ===\n&quot;);</span>
<span class="nc" id="L205">        report.append(String.format(&quot;Текущий баланс: %.2f \n&quot;, balance));</span>
<span class="nc" id="L206">        report.append(String.format(&quot;Доход за период: %.2f \n&quot;, income));</span>
<span class="nc" id="L207">        report.append(String.format(&quot;Расход за период: %.2f \n&quot;, expense));</span>
<span class="nc" id="L208">        report.append(&quot;Расходы по категориям:\n&quot;);</span>
<span class="nc" id="L209">        expensesByCategory.forEach((category, amount) -&gt;</span>
<span class="nc" id="L210">                report.append(String.format(&quot;- %s: %.2f \n&quot;, category, amount)));</span>
<span class="nc" id="L211">        return report.toString();</span>
    }

    /**
     * Возвращает список всех транзакций пользователя без фильтрации.
     *
     * @param userId уникальный идентификатор пользователя.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionNoFilter(long userId) {
<span class="nc" id="L221">        return formatTransactions(transactionRepository.findTransactionsByUserId(userId), &quot;Список транзакций:&quot;);</span>
    }

    /**
     * Возвращает список транзакций пользователя, отфильтрованных по дате.
     *
     * @param userId     уникальный идентификатор пользователя.
     * @param dateFilter дата для фильтрации.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsDateFilter(long userId, LocalDate dateFilter) {
<span class="nc" id="L232">        List&lt;Transaction&gt; filteredTransactions = transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc" id="L233">                .filter(transaction -&gt; transaction.getDate().isEqual(dateFilter))</span>
<span class="nc" id="L234">                .toList();</span>
<span class="nc" id="L235">        return formatTransactions(filteredTransactions, &quot;Список транзакций по дате &quot; + dateFilter + &quot;:&quot;);</span>
    }

    /**
     * Возвращает список транзакций пользователя, отфильтрованных по категории.
     *
     * @param userId         уникальный идентификатор пользователя.
     * @param categoryFilter категория для фильтрации.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsCategoryFilter(long userId, String categoryFilter) {
<span class="nc" id="L246">        List&lt;Transaction&gt; filteredTransactions = transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc" id="L247">                .filter(transaction -&gt; transaction.getCategory().equals(categoryFilter))</span>
<span class="nc" id="L248">                .toList();</span>
<span class="nc" id="L249">        return formatTransactions(filteredTransactions, &quot;Список транзакций по категории &quot; + categoryFilter + &quot;:&quot;);</span>
    }

    /**
     * Возвращает список транзакций пользователя, отфильтрованных по типу (доход/расход).
     *
     * @param userId         уникальный идентификатор пользователя.
     * @param isIncomeFilter true для доходов, false для расходов.
     * @return строка, содержащая список транзакций.
     */
    public String viewTransactionsIsIncomeFilter(long userId, boolean isIncomeFilter) {
<span class="nc" id="L260">        List&lt;Transaction&gt; filteredTransactions = transactionRepository.findTransactionsByUserId(userId).stream()</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                .filter(transaction -&gt; transaction.isIncome() == isIncomeFilter)</span>
<span class="nc" id="L262">                .toList();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        String type = isIncomeFilter ? &quot;Доходы&quot; : &quot;Расходы&quot;;</span>
<span class="nc" id="L264">        return formatTransactions(filteredTransactions, &quot;Список транзакций (&quot; + type + &quot;):&quot;);</span>
    }

    /**
     * Форматирует список транзакций в строку.
     *
     * @param transactions список транзакций.
     * @param header       заголовок для списка транзакций.
     * @return строка, содержащая отформатированный список транзакций.
     */
    private String formatTransactions(List&lt;Transaction&gt; transactions, String header) {
<span class="nc" id="L275">        StringBuilder transactionList = new StringBuilder();</span>

<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (transactions.isEmpty()) {</span>
<span class="nc" id="L278">            transactionList.append(&quot;Список транзакций пуст\n&quot;);</span>
        } else {
<span class="nc" id="L280">            transactionList.append(header + &quot;\n&quot;);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            for (Transaction transaction : transactions) {</span>
<span class="nc" id="L282">                transactionList.append(&quot;ID: &quot; + transaction.getId() +</span>
<span class="nc" id="L283">                        &quot;, Сумма: &quot; + transaction.getAmount() +</span>
<span class="nc" id="L284">                        &quot;, Категория: &quot; + transaction.getCategory() +</span>
<span class="nc" id="L285">                        &quot;, Дата: &quot; + transaction.getDate().toString() +</span>
<span class="nc" id="L286">                        &quot;, Описание: &quot; + transaction.getDescription() +</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                        &quot;, Тип: &quot; + (transaction.isIncome() ? &quot;Доход&quot; : &quot;Расход&quot;) + &quot;\n&quot;);</span>
<span class="nc" id="L288">            }</span>
        }

<span class="nc" id="L291">        return transactionList.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>